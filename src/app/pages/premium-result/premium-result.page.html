<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard" text="" icon="chevron-back-outline"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div *ngIf="isLoadingPayment" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando tu resultado...</p>
    <p *ngIf="showPaymentWaitMessage" class="wait-message">Verificando pago...</p>
  </div>

  <div *ngIf="!isLoadingPayment && result && result.result" class="content-container">
    <!-- ========================================== -->
    <div class="section-header">
      <h1>{{ result.result.dominant.titulo }}</h1>
      <p class="subtitle">{{ result.result.dominant.name }}</p>
    </div>

    <ion-card class="archetype-card dominant-card">
      <ion-card-content>
        <div class="main-info">
          <h2 class="esencia-title">Esencia</h2>
          <p class="esencia-text">{{ result.result.dominant.esencia }}</p>

          <div class="description-box ion-margin-top">
            <p>{{ result.result.dominant.description_full }}</p>
          </div>

          <div class="mantra-box ion-margin-top" *ngIf="result.result.dominant.mantra">
            <ion-icon name="infinite-outline"></ion-icon>
            <blockquote>"{{ result.result.dominant.mantra }}"</blockquote>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- LIGHT & SHADOW LISTS -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card class="list-card light">
            <ion-card-header>
              <ion-card-title><ion-icon name="sunny-outline"></ion-icon> En Luz</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ul>
                <li *ngFor="let item of result.result.dominant.enLuz">{{ item }}</li>
              </ul>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" size-md="6">
          <ion-card class="list-card shadow">
            <ion-card-header>
              <ion-card-title><ion-icon name="moon-outline"></ion-icon> En Sombra</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ul>
                <li *ngFor="let item of result.result.dominant.enSombra">{{ item }}</li>
              </ul>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- PAREJA PERFECTA -->
    <ion-card class="info-card">
      <ion-card-header>
        <ion-card-title>❤️ Pareja Perfecta</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-chip *ngFor="let pareja of result.result.dominant.parejaPerfecta" color="danger" outline="true">
          {{ pareja }}
        </ion-chip>
      </ion-card-content>
    </ion-card>

    <!-- COMPATIBILIDADES (DYNAMIC) -->
    <div class="ion-padding-horizontal ion-margin-top">
      <ion-button
        expand="block"
        color="tertiary"
        (click)="loadCompatibilities()"
        *ngIf="!compatibilitiesLoaded && !isLoadingCompatibilities"
      >
        <ion-icon name="heart-outline" slot="start"></ion-icon>
        Ver Análisis de Compatibilidad
      </ion-button>

      <div *ngIf="isLoadingCompatibilities" class="ion-text-center ion-padding">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando compatibilidades...</p>
      </div>
    </div>

    <div *ngIf="compatibilitiesLoaded" class="compatibilities-container">
      <div class="section-divider">
        <h3>Compatibilidades Detalladas</h3>
      </div>

      <ion-card *ngFor="let item of compatibilities" class="compatibility-card">
        <ion-card-header>
          <ion-card-title class="ion-text-wrap" style="font-size: 1.1rem">
            <span *ngFor="let a of item.arquetipos; let i = index">
              {{ getArchetypeName(a) }}<span *ngIf="i < item.arquetipos.length - 1"> + </span>
            </span>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div *ngIf="item.atraccion && item.atraccion.length > 0" class="ion-margin-bottom">
            <p class="label">Atracción</p>
            <ul class="ion-no-margin ion-padding-start">
              <li *ngFor="let t of item.atraccion">{{t}}</li>
            </ul>
          </div>

          <div *ngIf="item.luz && item.luz.length > 0" class="ion-margin-bottom">
            <p class="label">En Luz</p>
            <ul class="ion-no-margin ion-padding-start">
              <li *ngFor="let t of item.luz">{{t}}</li>
            </ul>
          </div>

          <div *ngIf="item.sombra && item.sombra.length > 0" class="ion-margin-bottom">
            <p class="label">En Sombra</p>
            <ul class="ion-no-margin ion-padding-start">
              <li *ngFor="let t of item.sombra">{{t}}</li>
            </ul>
          </div>

          <div *ngIf="item.conflicto && item.conflicto.length > 0" class="ion-margin-bottom">
            <p class="label">Conflicto</p>
            <ul class="ion-no-margin ion-padding-start">
              <li *ngFor="let t of item.conflicto">{{t}}</li>
            </ul>
          </div>

          <div *ngIf="item.clave" class="quote-box">
            <p><strong>Clave:</strong> {{ item.clave }}</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- ENERGIA -->
    <div class="section-divider">
      <h3>Energía y Evolución</h3>
    </div>
    <ion-card class="energy-card">
      <ion-card-content>
        <p class="intro-desc">{{ result.result.dominant.energia.descripcion }}</p>

        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <div class="energy-item">
                <span class="label">Color</span>
                <span class="value">{{ result.result.dominant.energia.color }}</span>
              </div>
            </ion-col>
            <ion-col size="6">
              <div class="energy-item">
                <span class="label">Piedra</span>
                <span class="value">{{ result.result.dominant.energia.piedra }}</span>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>

        <div class="energy-details ion-margin-top">
          <p><strong>Frase Luz:</strong> {{ result.result.dominant.energia.fraseLuz }}</p>
          <p><strong>Frase Sombra:</strong> {{ result.result.dominant.energia.fraseSombra }}</p>
          <p><strong>Hábito Luz:</strong> {{ result.result.dominant.energia.habitoLuz }}</p>
          <p><strong>Hábito Sombra:</strong> {{ result.result.dominant.energia.habitoSombra }}</p>
          <p><strong>Talento Humano:</strong> {{ result.result.dominant.energia.talentoHumano }}</p>
          <p><strong>Reto Evolutivo:</strong> {{ result.result.dominant.energia.retoEvolutivo }}</p>
          <p><strong>Necesita Aprender:</strong> {{ result.result.dominant.energia.necesitaAprender }}</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- VICTIMIZACION -->
    <div class="section-divider">
      <h3>Patrones de Victimizacion</h3>
    </div>
    <ion-card class="victim-card">
      <ion-card-content>
        <div class="quote-box">
          <p><em>"{{ result.result.dominant.victimizacion.frase }}"</em></p>
        </div>

        <div class="detail-box">
          <h4>¿Cómo se ve?</h4>
          <ul>
            <li *ngFor="let item of result.result.dominant.victimizacion.comoSeVe">{{ item }}</li>
          </ul>
        </div>

        <p><strong>Herida Raíz:</strong> {{ result.result.dominant.victimizacion.heridaRaiz }}</p>
        <p><strong>Frase Sombra:</strong> {{ result.result.dominant.victimizacion.fraseSombra }}</p>
        <p><strong>Salida a la Luz:</strong> {{ result.result.dominant.victimizacion.salidaALuz }}</p>
      </ion-card-content>
    </ion-card>

    <!-- DOMINANT - TRABAJO IDEAL -->
    <div class="section-divider">
      <h3>Trabajo Ideal (Dominante)</h3>
    </div>
    <ion-card class="work-card">
      <ion-card-content>
        <p><strong>Ambiente:</strong> {{ result.result.dominant.trabajoIdeal.ambiente }}</p>
        <p><strong>Evita:</strong> {{ result.result.dominant.trabajoIdeal.evita }}</p>
        <div class="roles-container ion-margin-top">
          <strong>Roles:</strong>
          <div class="chips">
            <ion-chip *ngFor="let role of result.result.dominant.trabajoIdeal.roles" color="primary">
              {{ role }}
            </ion-chip>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- DOMINANT - SOCIAL -->
    <div class="section-divider">
      <h3>Social (Dominante)</h3>
    </div>
    <ion-card class="social-card">
      <ion-card-content>
        <p><strong>Descripción:</strong> {{ result.result.dominant.social.descripcion }}</p>
        <p><strong>Límite Sano:</strong> {{ result.result.dominant.social.limiteSano }}</p>
      </ion-card-content>
    </ion-card>

    <!-- DOMINANT - DINERO -->
    <div class="section-divider">
      <h3>Dinero (Dominante)</h3>
    </div>
    <ion-card class="money-card">
      <ion-card-content>
        <ion-list lines="none" class="list-item-dinero">
          <ion-item>
            <ion-label class="ion-text-wrap"
              ><strong>Talento:</strong> {{ result.result.dominant.dinero.talento }}</ion-label
            >
          </ion-item>
          <ion-item>
            <ion-label class="ion-text-wrap"
              ><strong>Riesgo:</strong> {{ result.result.dominant.dinero.riesgo }}</ion-label
            >
          </ion-item>
          <ion-item>
            <ion-label class="ion-text-wrap"
              ><strong>Regla de Oro:</strong> {{ result.result.dominant.dinero.regla }}</ion-label
            >
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- ========================================== -->
    <!-- 2. SECONDARY ARCHETYPE                     -->
    <!-- ========================================== -->
    <div class="section-header secondary-header ion-margin-top">
      <p class="subtitle">Tu Arquetipo Secundario</p>
      <h2>{{ result.result.secondary.titulo }}</h2>
    </div>
    <ion-card class="archetype-card secondary-card">
      <ion-card-content>
        <p class="description">{{ result.result.secondary.descripcion }}</p>

        <div class="subsection ion-margin-top">
          <h4>Trabajo</h4>
          <p><strong>Ambiente:</strong> {{ result.result.secondary.trabajo.ambiente }}</p>
          <p><strong>Evita:</strong> {{ result.result.secondary.trabajo.evita }}</p>
          <div class="roles-container">
            <strong>Roles:</strong>
            <span *ngFor="let role of result.result.secondary.trabajo.roles; let isLast=last">
              {{ role }}{{ isLast ? '' : ', ' }}
            </span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- ========================================== -->
    <!-- 3. SHADOW ARCHETYPE                        -->
    <!-- ========================================== -->
    <div class="section-header shadow-header ion-margin-top">
      <p class="subtitle">Tu Sombra</p>
      <h2>{{ result.result.shadow.titulo }}</h2>
    </div>
    <ion-card class="archetype-card shadow-card">
      <ion-card-content>
        <p class="description">{{ result.result.shadow.descripcion }}</p>
        <div class="subsection ion-margin-top">
          <h4>En Sombra</h4>
          <ul>
            <li *ngFor="let item of result.result.shadow.enSombra">{{ item }}</li>
          </ul>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- ========================================== -->
    <!-- 4. WORK ARCHETYPE                          -->
    <!-- ========================================== -->
    <div class="section-header work-header ion-margin-top">
      <p class="subtitle">Tu Arquetipo en el Trabajo</p>
      <h2>{{ result.result.work.titulo }}</h2>
    </div>
    <ion-card class="archetype-card work-card">
      <ion-card-content>
        <p class="description">{{ result.result.work.descripcion }}</p>
        <div class="subsection ion-margin-top">
          <h4>Dinámica Laboral</h4>
          <p><strong>Ambiente:</strong> {{ result.result.work.trabajo.ambiente }}</p>
          <p><strong>Evita:</strong> {{ result.result.work.trabajo.evita }}</p>
          <p><strong>Roles:</strong> {{ result.result.work.trabajo.roles.join(', ') }}</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- ========================================== -->
    <!-- 5. SOCIAL ARCHETYPE                        -->
    <!-- ========================================== -->
    <div class="section-header social-header ion-margin-top">
      <p class="subtitle">Tu Arquetipo Social</p>
      <h2>{{ result.result.social.titulo }}</h2>
    </div>
    <ion-card class="archetype-card social-card">
      <ion-card-content>
        <p class="description">{{ result.result.social.descripcion }}</p>
        <div class="subsection ion-margin-top">
          <p><strong>Descripción:</strong> {{ result.result.social.social.descripcion }}</p>
          <p><strong>Límite Sano:</strong> {{ result.result.social.social.limiteSano }}</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- ========================================== -->
    <!-- 6. MONEY ARCHETYPE                         -->
    <!-- ========================================== -->
    <div class="section-header money-header ion-margin-top">
      <p class="subtitle">Tu Arquetipo del Dinero</p>
      <h2>{{ result.result.money.titulo }}</h2>
    </div>
    <ion-card class="archetype-card money-card">
      <ion-card-content>
        <p class="description">{{ result.result.money.descripcion }}</p>
        <div class="subsection ion-margin-top">
          <p><strong>Talento:</strong> {{ result.result.money.dinero.talento }}</p>
          <p><strong>Riesgo:</strong> {{ result.result.money.dinero.riesgo }}</p>
          <p><strong>Regla de Oro:</strong> {{ result.result.money.dinero.regla }}</p>
        </div>
      </ion-card-content>
    </ion-card>

    <div class="actions ion-padding ion-margin-top">
      <ion-button expand="block" (click)="goToDashboard()"> Ir al Dashboard </ion-button>
    </div>

    <div class="safe-area-spacer"></div>
  </div>

  <!-- STATE: PREVIEW (NOT PAID) -->
  <div *ngIf="!isLoadingPayment && result && !result.result" class="content-container ion-padding ion-text-center">
    <div class="blur-preview-container ion-margin-bottom ion-margin-top">
      <img [src]="previewImage" class="blur-image" />
      <div class="lock-icon">
        <ion-icon name="lock-closed" style="font-size: 40px; color: white"></ion-icon>
      </div>
    </div>

    <ion-card>
      <ion-card-header>
        <ion-card-subtitle>Parece que eres un...</ion-card-subtitle>
        <ion-card-title color="primary" style="font-size: 2em"
          >{{ result.preview?.typeName || 'Arquetipo' }}</ion-card-title
        >
      </ion-card-header>
      <ion-card-content>
        <p style="font-size: 1.2em; font-style: italic; margin-bottom: 20px">
          "{{ result.preview?.snippet || '...' }}"
        </p>

        <div class="blur-container ion-margin-top">
          <div style="filter: blur(4px); user-select: none; opacity: 0.6">
            <h3>Tu Estilo en el Trabajo</h3>
            <p>Descubre cómo te comportas bajo presión, tus roles ideales y lo que debes evitar para no quemarte.</p>
            <h3>Tus Relaciones Sociales</h3>
            <p>Entiende tu vibra natural, cómo pones límites y qué tipo de personas te complementan mejor.</p>
            <h3>Tu Relación con el Dinero</h3>
            <p>Conoce tu talento oculto para generar riqueza y tu mayor riesgo financiero.</p>
            <h3>Tus Patrones de Sombra</h3>
            <p>Identifica esos comportamientos inconscientes que te sabotean y cómo transformarlos en luz.</p>
          </div>

          <div class="lock-overlay">
            <ion-icon name="lock-closed" size="large" color="medium"></ion-icon>
            <p style="font-weight: bold; color: #333; margin: 10px 0 0">Análisis Completo Bloqueado</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 5px">Desbloquea tu reporte detallado ahora.</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-button expand="block" class="ion-margin-top action-btn" (click)="goToPayment()">
      Desbloquear Informe Completo
      <ion-icon slot="end" name="card"></ion-icon>
    </ion-button>

    <p class="ion-text-small ion-margin-top" style="color: rgba(255, 255, 255, 0.8)">
      Obtén tu perfil detallado, consejos de carrera y relaciones por solo $4.99
    </p>

    <ion-button expand="block" fill="outline" class="secondary-btn ion-margin-top" (click)="goToDashboard()">
      Ir al Dashboard
      <ion-icon slot="end" name="grid-outline"></ion-icon>
    </ion-button>

    <div class="safe-area-spacer"></div>
  </div>

  <!-- Fallback/Empty State -->
  <div
    *ngIf="!isLoadingPayment && (!result || (!result.result && !result.preview))"
    class="ion-padding ion-text-center"
  >
    <p>No se pudo cargar el resultado.</p>
    <ion-button (click)="goToDashboard()">Volver</ion-button>
  </div>
</ion-content>
